@{
    ViewData["Title"] = "Team Details - Admin";
    Layout = null;
    var team = ViewBag.Team as TeamPro1.Models.Team;
    var projectProgress = ViewBag.ProjectProgress as TeamPro1.Models.ProjectProgress;
    var teamMeetings = ViewBag.TeamMeetings as List<TeamPro1.Models.TeamMeeting>;
    var faculties = ViewBag.Faculties as List<TeamPro1.Models.Faculty>;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Team #@team?.TeamNumber Details - Admin - TeamPro1</title>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <style>
        :root {
            --royal-blue: #274060; --warm-gold: #FFC857; --cream: #F9FAF2;
            --slate: #CED3DC; --card-shadow: rgba(39,64,96,0.13);
            --success-green: #28a745; --error-red: #dc3545; --admin-orange: #fd7e14; --info-blue: #17a2b8;
        }

        body {
            min-height: 100vh; margin: 0; padding: 20px 0;
            font-family: 'Montserrat', Arial, sans-serif;
            background: linear-gradient(rgba(249, 250, 242, 0.15), rgba(255, 200, 87, 0.10)),
            url('@Url.Content("~/images/RGMCET-BACKGROUND.jpg")') center center/cover no-repeat fixed;
            position: relative;
        }
        body::before { content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; background: linear-gradient(135deg, var(--cream) 60%, var(--warm-gold) 100%); opacity: 0.20; pointer-events: none; }

        .main-container { position: relative; z-index: 1; max-width: 1000px; margin: 0 auto; padding: 0 20px; }

        .nav-link { position: fixed; top: 20px; left: 20px; background: rgba(249,250,242,0.9); color: var(--royal-blue); padding: 10px 20px; border-radius: 25px; text-decoration: none; font-weight: 600; border: 2px solid var(--slate); backdrop-filter: blur(8px); transition: all 0.3s ease; z-index: 100; }
        .nav-link:hover { background: var(--warm-gold); transform: translateY(-2px); text-decoration: none; }

        .page-header { background: rgba(249,250,242,0.92); box-shadow: 0 8px 32px var(--card-shadow); border-radius: 20px; padding: 30px 40px; text-align: center; backdrop-filter: blur(12px); margin-bottom: 30px; border: 2px solid var(--slate); margin-top: 60px; }
        .page-header h2 { font-size: 2em; font-weight: 700; color: var(--royal-blue); margin: 0; }

        .detail-section { background: rgba(249,250,242,0.95); border-radius: 20px; padding: 25px; border: 2px solid var(--slate); box-shadow: 0 8px 32px var(--card-shadow); margin-bottom: 25px; }

        .section-title { font-size: 1.3em; font-weight: 700; color: var(--royal-blue); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid var(--slate); }
        .section-title i { margin-right: 10px; color: var(--admin-orange); }

        .student-row { display: flex; align-items: center; gap: 15px; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 12px; margin-bottom: 10px; }
        .student-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, var(--admin-orange), var(--warm-gold)); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2em; }
        .student-details h4 { margin: 0 0 5px 0; color: var(--royal-blue); }
        .student-details p { margin: 0; font-size: 0.9em; color: #666; }

        .current-value { padding: 12px 16px; background: rgba(253,126,20,0.1); border-radius: 10px; border-left: 4px solid var(--admin-orange); margin-bottom: 15px; }
        .current-label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .current-text { color: var(--royal-blue); font-weight: 600; }

        .progress-display { margin: 20px 0; }
        .progress-bar-container { background: var(--slate); border-radius: 15px; height: 20px; overflow: hidden; margin-bottom: 10px; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--admin-orange), var(--success-green)); border-radius: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.8em; font-weight: 600; }

        .meetings-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .meetings-table th, .meetings-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--slate); }
        .meetings-table th { background: rgba(253,126,20,0.1); color: var(--royal-blue); font-weight: 600; }
        .meetings-table tr:hover td { background: rgba(255,200,87,0.1); }

        .meeting-status { padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: 600; }
        .status-completed { background: rgba(40,167,69,0.15); color: var(--success-green); }
        .status-pending { background: rgba(255,193,7,0.15); color: #856404; }

        .proof-link { color: var(--admin-orange); text-decoration: none; font-weight: 600; }
        .proof-link:hover { color: var(--royal-blue); text-decoration: underline; }

        .no-data { text-align: center; padding: 30px; color: #666; }
        .no-data i { font-size: 2em; color: var(--slate); margin-bottom: 10px; display: block; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-item { padding: 12px; background: rgba(255,255,255,0.5); border-radius: 10px; }
        .info-label { font-size: 0.85em; color: #666; margin-bottom: 5px; }
        .info-value { font-weight: 600; color: var(--royal-blue); }

        /* Assignment Forms */
        .assign-form-group { margin-bottom: 18px; }
        .assign-form-group label {
            display: block; font-weight: 600; color: var(--royal-blue);
            margin-bottom: 8px; font-size: 0.95em;
        }
        .assign-form-group select,
        .assign-form-group textarea {
            width: 100%; padding: 12px 16px; border: 2px solid var(--slate);
            border-radius: 12px; font-size: 1em; font-family: 'Montserrat', sans-serif;
            background: rgba(249,250,242,0.8); transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }
        .assign-form-group select:focus,
        .assign-form-group textarea:focus {
            outline: none; border-color: var(--admin-orange);
            box-shadow: 0 0 0 3px rgba(253,126,20,0.2);
        }
        .assign-form-group textarea { resize: vertical; min-height: 80px; }

        .assign-btn {
            display: inline-flex; align-items: center; gap: 8px;
            background: linear-gradient(90deg, var(--admin-orange) 74%, var(--warm-gold) 100%);
            color: #fff; border: none; border-radius: 12px;
            padding: 12px 28px; font-size: 1em; font-weight: 600;
            cursor: pointer; box-shadow: 0 6px 20px var(--card-shadow);
            transition: all 0.3s ease; font-family: 'Montserrat', sans-serif;
        }
        .assign-btn:hover {
            background: linear-gradient(90deg, var(--warm-gold) 62%, var(--admin-orange) 100%);
            color: var(--royal-blue); transform: translateY(-2px);
            box-shadow: 0 10px 28px rgba(253,126,20,0.3);
        }
        .assign-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .assign-row { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .assign-row .assign-form-group { flex: 1; min-width: 200px; margin-bottom: 0; }

        .toast-msg {
            display: none; padding: 12px 18px; border-radius: 10px; font-weight: 600;
            margin-top: 12px; font-size: 0.95em;
        }
        .toast-success { background: rgba(40,167,69,0.15); color: var(--success-green); border: 1px solid var(--success-green); }
        .toast-error { background: rgba(220,53,69,0.15); color: var(--error-red); border: 1px solid var(--error-red); }

        .current-badge {
            display: inline-block; padding: 4px 14px; border-radius: 15px;
            font-size: 0.85em; font-weight: 600; margin-bottom: 12px;
        }
        .badge-assigned { background: rgba(40,167,69,0.15); color: var(--success-green); }
        .badge-not-assigned { background: rgba(108,117,125,0.15); color: #6c757d; }

        .app-footer { background: rgba(249,250,242,0.95); backdrop-filter: blur(12px); border-top: 3px solid var(--slate); box-shadow: 0 -8px 32px rgba(39,64,96,0.13); padding: 30px 20px; margin-top: 50px; text-align: center; color: #274060; border-radius: 20px 20px 0 0; }
        .footer-content { max-width: 1200px; margin: 0 auto; }
        .footer-line { margin: 8px 0; line-height: 1.6; }
        .footer-line.guidance { font-size: 1em; font-weight: 600; color: #444; margin-bottom: 12px; }
        .footer-line.team { font-size: 0.95em; font-weight: 500; color: #444; }
        .footer-line.copyright { font-size: 0.9em; font-weight: 600; color: #274060; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(39,64,96,0.1); }
        .footer-highlight { color: #274060; font-weight: 700; }
        .footer-name { color: #274060; font-weight: 600; }

        @@media (max-width: 768px) {
            .nav-link { position: static; display: inline-block; margin: 10px auto; }
            .page-header { margin-top: 20px; }
            .info-grid { grid-template-columns: 1fr; }
            .meetings-table { display: block; overflow-x: auto; }
            .assign-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    @Html.Partial("_AdminBackButton")
    
    <a id="backLink" href="@Url.Action("ManageTeams", "Admin")" class="nav-link"><i class="fas fa-arrow-left"></i> <span id="backLabel">Back to Teams</span></a>

    <script>
        (function () {
            var referrer = document.referrer || '';
            if (referrer.indexOf('ViewAllProgress') !== -1) {
                document.getElementById('backLink').href = referrer;
                document.getElementById('backLabel').textContent = 'Back to Project Progress';
            }
        })();
    </script>

    <div class="main-container">
        <div class="page-header">
            <h2><i class="fas fa-users-cog"></i> Team #@team?.TeamNumber Details</h2>
            <p style="margin-top: 8px;">
                <span style="display: inline-block; background: linear-gradient(90deg, var(--admin-orange), var(--warm-gold)); color: white; padding: 4px 14px; border-radius: 15px; font-weight: 600; font-size: 0.9em;">
                    <i class="fas fa-building"></i> @ViewBag.AdminDepartment
                </span>
            </p>
        </div>

        <!-- Team Members Section -->
        <div class="detail-section">
            <div class="section-title"><i class="fas fa-users"></i> Team Members</div>

            @if (team?.Student1 != null)
            {
                <div class="student-row">
                    <div class="student-avatar"><i class="fas fa-user"></i></div>
                    <div class="student-details">
                        <h4>@team.Student1.FullName</h4>
                        <p>@team.Student1.RegdNumber | @team.Student1.Email</p>
                        <p>Year @team.Student1.Year, Semester @team.Student1.Semester | @team.Student1.Department</p>
                    </div>
                </div>
            }

            @if (team?.Student2 != null)
            {
                <div class="student-row">
                    <div class="student-avatar"><i class="fas fa-user"></i></div>
                    <div class="student-details">
                        <h4>@team.Student2.FullName</h4>
                        <p>@team.Student2.RegdNumber | @team.Student2.Email</p>
                        <p>Year @team.Student2.Year, Semester @team.Student2.Semester | @team.Student2.Department</p>
                    </div>
                </div>
            }
        </div>

        <!-- ? ASSIGN FACULTY MENTOR Section ? -->
        <div class="detail-section">
            <div class="section-title"><i class="fas fa-chalkboard-teacher"></i> Assign Faculty Mentor</div>

            @if (projectProgress?.AssignedFaculty != null)
            {
                <span class="current-badge badge-assigned">
                    <i class="fas fa-check-circle"></i> Currently assigned: @projectProgress.AssignedFaculty.FullName
                </span>
            }
            else
            {
                <span class="current-badge badge-not-assigned">
                    <i class="fas fa-exclamation-circle"></i> No mentor assigned yet
                </span>
            }

            @if (faculties != null && faculties.Count > 0)
            {
                <div class="assign-row" style="margin-top: 12px;">
                    <div class="assign-form-group">
                        <label><i class="fas fa-user-tie"></i> Select Faculty</label>
                        <select id="facultySelect">
                            <option value="">-- Choose a faculty mentor --</option>
                            @foreach (var f in faculties)
                            {
                                if (projectProgress?.AssignedFacultyId == f.Id)
                                {
                                    <option value="@f.Id" selected="selected">@f.FullName (@f.Email)</option>
                                }
                                else
                                {
                                    <option value="@f.Id">@f.FullName (@f.Email)</option>
                                }
                            }
                        </select>
                    </div>
                    <div>
                        <button class="assign-btn" id="assignFacultyBtn" onclick="assignFaculty()">
                            <i class="fas fa-user-check"></i> Assign Mentor
                        </button>
                    </div>
                </div>
                <div class="toast-msg" id="facultyToast"></div>
            }
            else
            {
                <div class="no-data" style="padding: 15px;">
                    <p>No faculty available in your department. <a href="@Url.Action("AddFaculty", "Admin")" style="color: var(--admin-orange); font-weight: 600;">Add Faculty</a> first.</p>
                </div>
            }
        </div>

        <!-- ? SET PROBLEM STATEMENT Section ? -->
        <div class="detail-section">
            <div class="section-title"><i class="fas fa-lightbulb"></i> Problem Statement</div>

            @if (!string.IsNullOrEmpty(projectProgress?.ProblemStatement))
            {
                <div class="current-value" style="margin-bottom: 18px;">
                    <div class="current-label">Current Problem Statement</div>
                    <div class="current-text">@projectProgress.ProblemStatement</div>
                </div>
            }
            else
            {
                <span class="current-badge badge-not-assigned" style="margin-bottom: 12px; display: inline-block;">
                    <i class="fas fa-exclamation-circle"></i> No problem statement assigned yet
                </span>
            }

            <div class="assign-form-group" style="margin-top: 10px;">
                <label><i class="fas fa-edit"></i> @(string.IsNullOrEmpty(projectProgress?.ProblemStatement) ? "Set" : "Update") Problem Statement</label>
                <textarea id="problemStatementInput" placeholder="Enter the problem statement for this team...">@(projectProgress?.ProblemStatement ?? "")</textarea>
            </div>
            <button class="assign-btn" id="setProblemBtn" onclick="setProblemStatement()">
                <i class="fas fa-save"></i> Save Problem Statement
            </button>
            <div class="toast-msg" id="problemToast"></div>
        </div>

        <!-- Project Progress Info Section -->
        <div class="detail-section">
            <div class="section-title"><i class="fas fa-chart-line"></i> Project Progress</div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value">@(projectProgress?.Status ?? "Not Started")</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Last Updated</div>
                    <div class="info-value">@(projectProgress?.LastUpdated?.ToString("MMM dd, yyyy HH:mm") ?? "N/A")</div>
                </div>
            </div>

            <div class="progress-display" style="margin-top: 20px;">
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: @(projectProgress?.CompletionPercentage ?? 0)%">
                        @(projectProgress?.CompletionPercentage ?? 0)%
                    </div>
                </div>
                <p style="text-align: center; color: #666; font-weight: 600;">Completion: @(projectProgress?.CompletionPercentage ?? 0)%</p>
            </div>

            @if (!string.IsNullOrEmpty(projectProgress?.FacultyReview))
            {
                <div class="current-value" style="margin-top: 15px;">
                    <div class="current-label">Faculty Review</div>
                    <div class="current-text">@projectProgress.FacultyReview</div>
                </div>
            }
        </div>

        <!-- Meetings Section -->
        <div class="detail-section">
            <div class="section-title"><i class="fas fa-calendar-check"></i> Team Meetings</div>

            @if (teamMeetings == null || teamMeetings.Count == 0)
            {
                <div class="no-data">
                    <i class="fas fa-calendar-times"></i>
                    <p>No meetings recorded yet for this team.</p>
                </div>
            }
            else
            {
                <table class="meetings-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Notes</th>
                            <th>Progress</th>
                            <th>Proof</th>
                            <th>Faculty Review</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var meeting in teamMeetings)
                        {
                            <tr>
                                <td>@meeting.MeetingNumber</td>
                                <td>@meeting.MeetingDate.ToString("MMM dd, yyyy")</td>
                                <td>@(string.IsNullOrEmpty(meeting.Notes) ? "-" : meeting.Notes)</td>
                                <td>@meeting.CompletionPercentage%</td>
                                <td>
                                    @if (meeting.ProofImageData != null && meeting.ProofImageData.Length > 0 || !string.IsNullOrEmpty(meeting.ProofUploads))
                                    {
                                        <a href="@Url.Action("GetProofImage", "Student", new { id = meeting.Id })" target="_blank" class="proof-link">
                                            <i class="fas fa-image"></i> View
                                        </a>
                                    }
                                    else
                                    {
                                        <span style="color:#999;">-</span>
                                    }
                                </td>
                                <td>
                                    @if (!string.IsNullOrEmpty(meeting.FacultyReview))
                                    {
                                        <span>@meeting.FacultyReview</span>
                                    }
                                    else
                                    {
                                        <span style="color:#999; font-style: italic;">Pending review</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    <footer class="app-footer">
        <div class="footer-content">
            <div class="footer-line guidance">Developed under the guidance of <span class="footer-highlight">Dr. P. Penchala Prasad</span>, Associate Professor, CSE(DS), RGMCET</div>
            <div class="footer-line team">With team <span class="footer-name">Mr. S. Md. Shahid Afrid</span> (23091A32D4) & <span class="footer-name">Ms. G. Veena</span> (23091A32H9)</div>
            <div class="footer-line copyright">&copy; All Rights Reserved @@2025</div>
        </div>
    </footer>

    @Html.AntiForgeryToken()

    <script>
        function showToast(elementId, message, isSuccess) {
            var toast = document.getElementById(elementId);
            toast.textContent = message;
            toast.className = 'toast-msg ' + (isSuccess ? 'toast-success' : 'toast-error');
            toast.style.display = 'block';
            setTimeout(function () {
                if (isSuccess) location.reload();
            }, 1500);
        }

        async function assignFaculty() {
            var facultyId = document.getElementById('facultySelect').value;
            if (!facultyId) {
                showToast('facultyToast', 'Please select a faculty member.', false);
                return;
            }

            var btn = document.getElementById('assignFacultyBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Assigning...';

            try {
                var formData = new FormData();
                formData.append('teamId', '@team?.Id');
                formData.append('facultyId', facultyId);
                var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                if (tokenInput) formData.append('__RequestVerificationToken', tokenInput.value);

                var response = await fetch('@Url.Action("AssignFaculty", "Admin")', {
                    method: 'POST',
                    body: formData
                });
                var result = await response.json();
                showToast('facultyToast', result.message, result.success);
            } catch (e) {
                showToast('facultyToast', 'Error assigning faculty.', false);
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-user-check"></i> Assign Mentor';
        }

        async function setProblemStatement() {
            var problemStatement = document.getElementById('problemStatementInput').value.trim();
            if (!problemStatement) {
                showToast('problemToast', 'Please enter a problem statement.', false);
                return;
            }

            var btn = document.getElementById('setProblemBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                var formData = new FormData();
                formData.append('teamId', '@team?.Id');
                formData.append('problemStatement', problemStatement);
                var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                if (tokenInput) formData.append('__RequestVerificationToken', tokenInput.value);

                var response = await fetch('@Url.Action("SetProblemStatement", "Admin")', {
                    method: 'POST',
                    body: formData
                });
                var result = await response.json();
                showToast('problemToast', result.message, result.success);
            } catch (e) {
                showToast('problemToast', 'Error saving problem statement.', false);
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-save"></i> Save Problem Statement';
        }
    </script>
</body>
</html>
